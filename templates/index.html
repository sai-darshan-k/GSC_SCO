<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Scholars Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .logo {
        position: absolute;
        top: 10px; 
        left: 50%;
        transform: translateX(-50%);
        z-index: 2; 
        }

.logo img {
    max-width: 100px; 
    height: auto;
}
        h1 {
    text-align: center;
    font-size: 28px;
    color: #0056b3;
    margin-bottom: 10px;
    font-weight: bold;
    margin-top: 90px; 
}

h2 {
    text-align: center;
    font-size: 22px;
    color: #333;
    margin-bottom: 10px;
    margin-top: 10px; 
}
.container {
    max-width: 1000px;
    margin: auto;
    background-color: white;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    position: relative;
    padding-top: 60px;
    min-height: 245px;
}
        .table-separator {
    border-left: 2px solid #ff6347;
}

#resultsTable tbody td:nth-child(6) {
    border-left: 2px solid #ff6347;
}
        .radio-group {
            display: flex;
            margin-bottom: 20px;
            justify-content: flex-start;
        }

        .radio-group label {
            margin-right: 20px;
            color: #333;
        }

        .radio-group input[type="radio"] {
            margin-right: 10px;
        }

        button {
    background-color: #0056b3;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s;
    margin-left: 50px;
    margin-top: -5px;  
    position: relative; 
    top:45px;
    z-index: 1000;  
}


        button:hover {
            background-color: #004494;
        }

        .separator-line {
            border-bottom: 2px solid #ccc;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #0056b3;
            color: white;
            text-transform: uppercase;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .hidden {
            display: none;
        }

        .table-separator {
            border-left: 2px solid #ff6347;
        }
        .scopus-papers-table {
    width: auto;
    max-width: 100%;
    margin-bottom: 1rem;
    border-collapse: collapse;
}

.scopus-papers-table th,
.scopus-papers-table td {
    padding: 0.75rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
    text-align: left;
    white-space: nowrap;
}

.scopus-papers-table thead th {
    vertical-align: bottom;
    border-bottom: 2px solid #dee2e6;
}

.scopus-papers-table tbody + tbody {
    border-top: 2px solid #dee2e6;
}

.scopus-papers-table .paper-title {
    max-width: 300px;
    white-space: normal;
    word-wrap: break-word;
}

        .google-scholar-header, .scopus-header {
            text-align: center;
        }

        @media (max-width: 600px) {
            button {
                width: 100%;
            }
        }

        .radio-container {
    position: absolute;
    top: 105px; 
    left: 20px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-width: 250px;
    background-color: white;
    z-index: 1;
}

        .radio-row {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .radio-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width:250px;
        }


        .radio-row label {
            margin: 5px 0;
            display: flex;
            align-items: center;
            width: 100%;
        }

        .radio-row input[type="radio"] {
            margin-right: 10px;
        }
        #generateButton {
            margin-top: 10px;
        }
        .table-wrapper {
    max-height: 500px; 
    overflow-y: auto;
    border: 1px solid #ddd;
}

#paperDetailsScopusTable {
    width: 100%;
}

#paperDetailsScopusTable thead {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 1;
}

#paperDetailsScopusContainer {
    margin-top: 20px;
    max-width: 1000px;  
    margin-left: auto;
    margin-right: auto;
}
#table-container {
    position: relative;
}

#download-btn {
    display: none;
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background-color: #0056b3;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s;
}

#download-btn:hover {
    background-color: #004494;
}
        #table-container {
            position: relative;
        }

            
    /* .radio-row:first-child {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    } */

 </style>
</head>
<body>

    <div class="container">
        <div class="logo">
            <img src="{{ url_for('static', filename='clogo.png') }}" alt="Logo">
        </div>
        <h1>CS Scholars Data</h1>
        <h2>Citation Report</h2>
        
        <div class="radio-container">
            <div class="radio-row">
                <label>
                    <input type="radio" name="citationSource" value="both">
                    Google Scholar & Scopus
                </label>
                <label>
                    <input type="radio" name="citationSource" value="paperDetails">
                    Paper Details (Google Scholar)
                </label>
                <label>
                    <input type="radio" name="citationSource" value="paperDetailsScopus">
                    Paper Details (Scopus)
                </label>
                <label>
                    <input type="radio" name="citationSource" value="average">
                    Average Citation
                </label>
            </div>
            <div class="radio-row">
                <label>
                    <input type="radio" name="citationSource" value="googleScholarOnly">
                    Yearly Citations
                </label>
            </div>
        </div>
    
        <button id="generateButton">Generate Report</button>
        <div id="table-container">
            <button id="download-btn" onclick="downloadExcel()">Download</button>
        <div id="resultContainer" class="hidden">
            <h2>Results</h2>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th colspan="4" class="google-scholar-header">Google Scholar</th>
                        <th class="table-separator scopus-header" colspan="3">Scopus</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="google-scholar-header">Total Papers</th>
                        <th class="google-scholar-header">Total Citations</th>
                        <th class="google-scholar-header">H-Index</th>
                        <th class="google-scholar-header">I10 Index</th>
                        <th class="table-separator scopus-header">Total Papers</th>
                        <th class="scopus-header">Total Citations</th>
                        <th class="scopus-header">H-Index</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- data is be populated here -->
                </tbody>
            </table>
        </div>

        <div id="googleScholarOnlyContainer" class="hidden">
            <h2>Yearly Citations(Google scholar)</h2>
            <table id="googleScholarOnlyTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Citations</th>
                        <th>H-Index</th>
                        <th>I10-Index</th>
                        <th>Yearly Citations</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- data will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="paperDetailsContainer" class="hidden">
            <h2>Paper Details (Google Scholar)</h2>
            <table id="paperDetailsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Title</th>
                        <th>Year</th>
                        <th>Citations</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="table-wrapper"></div>
    <div id="paperDetailsScopusContainer" class="hidden">
        <h2>Paper Details (Scopus)</h2>
        <table id="paperDetailsScopusTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Year</th>
                    <th>Citations</th>
                </tr>
            </thead>
            <tbody>
                <!-- data will be populated here -->
            </tbody>
        </table>
    </div>
    <div id="loadingIndicator" style="display: none; text-align: center; margin-top: 20px;">
        <p>Loading... Please wait</p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
    document.getElementById('generateButton').addEventListener('click', function () {
    const source = document.querySelector('input[name="citationSource"]:checked').value;
    const resultContainer = document.getElementById('resultContainer');
    const googleScholarOnlyContainer = document.getElementById('googleScholarOnlyContainer');
    const paperDetailsContainer = document.getElementById('paperDetailsContainer');
    const paperDetailsScopusContainer = document.getElementById('paperDetailsScopusContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsTableBody = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
    const googleScholarOnlyTableBody = document.getElementById('googleScholarOnlyTable').getElementsByTagName('tbody')[0];
    const paperDetailsTableBody = document.getElementById('paperDetailsTable').getElementsByTagName('tbody')[0];
    const paperDetailsScopusTableBody = document.getElementById('paperDetailsScopusTable').getElementsByTagName('tbody')[0];

    // Clear previous results
    resultsTableBody.innerHTML = '';
    googleScholarOnlyTableBody.innerHTML = '';
    paperDetailsTableBody.innerHTML = '';
    paperDetailsScopusTableBody.innerHTML = '';

    // Hide all result containers initially
    resultContainer.classList.add('hidden');
    googleScholarOnlyContainer.classList.add('hidden');
    paperDetailsContainer.classList.add('hidden');
    paperDetailsScopusContainer.classList.add('hidden');

    [resultContainer, googleScholarOnlyContainer, paperDetailsContainer, paperDetailsScopusContainer].forEach(container => {
        container.classList.add('hidden');
        if (container.getElementsByTagName('tbody')[0]) {
            container.getElementsByTagName('tbody')[0].innerHTML = '';
        }
    });
    
    // Show loading indicator
    loadingIndicator.style.display = 'block';

    // Fetch data from the server
    fetch('/generate_report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ source: source })
    })
    .then(response => response.json())
    .then(data => {
            const totalAuthors = data.length;

            loadingIndicator.style.display = 'none';

            if (source === 'average') {
                const authorsAverages = data.map(author => {
                    const averagePapersGS = (author['Total Papers (Google Scholar)'] || 0) / totalAuthors;
                    const averageCitationsGS = (author['Total Citations (Google Scholar)'] || 0) / totalAuthors;
                    const averageHIndexGS = (author['H-Index (Google Scholar)'] || 0) / totalAuthors;
                    const averageI10IndexGS = (author['I10 Index (Google Scholar)'] || 0) / totalAuthors;

                    const averagePapersScopus = (author['Total Papers (Scopus)'] || 0) / totalAuthors;
                    const averageCitationsScopus = (author['Total Citations (Scopus)'] || 0) / totalAuthors;
                    const averageHIndexScopus = (author['H-Index (Scopus)'] || 0) / totalAuthors;

                    return {
                        name: author.Name,
                        averagePapersGS: averagePapersGS.toFixed(2),
                        averageCitationsGS: averageCitationsGS.toFixed(2),
                        averageHIndexGS: averageHIndexGS.toFixed(2),
                        averageI10IndexGS: averageI10IndexGS.toFixed(2),
                        averagePapersScopus: averagePapersScopus.toFixed(2),
                        averageCitationsScopus: averageCitationsScopus.toFixed(2),
                        averageHIndexScopus: averageHIndexScopus.toFixed(2)
                    };
                });

                // Display average data for both Google Scholar and Scopus
                authorsAverages.forEach(author => {
                    const row = resultsTableBody.insertRow();
                    row.insertCell(0).innerText = author.name || 'N/A';
                    row.insertCell(1).innerText = author.averagePapersGS || 'N/A';
                    row.insertCell(2).innerText = author.averageCitationsGS || 'N/A';
                    row.insertCell(3).innerText = author.averageHIndexGS || 'N/A';
                    row.insertCell(4).innerText = author.averageI10IndexGS || 'N/A';
                    row.insertCell(5).innerText = author.averagePapersScopus || 'N/A';
                    row.insertCell(6).innerText = author.averageCitationsScopus || 'N/A';
                    row.insertCell(7).innerText = author.averageHIndexScopus || 'N/A';
                });

                resultContainer.classList.remove('hidden');
                showDownloadButton();

            } else if (source === 'googleScholarOnly') {
                // Populate Google Scholar only results
                data.forEach(author => {
                    const row = googleScholarOnlyTableBody.insertRow();
                    row.insertCell(0).innerText = author.Name || 'N/A';
                    row.insertCell(1).innerText = author['Total Citations'] || 'N/A';
                    row.insertCell(2).innerText = author['H-Index'] || 'N/A';
                    row.insertCell(3).innerText = author['I10 Index'] || 'N/A';
                    row.insertCell(4).innerText = author['Yearly Citations'] || 'N/A';
                });
                googleScholarOnlyContainer.classList.remove('hidden');
                showDownloadButton();

            }else if (source === 'paperDetailsScopus') {
        let authorCounter = 1;

        data.forEach(author => {
            let paperCounter = 1;
            
                    // addd author name as a header row with link
                    const headerRow = paperDetailsScopusTableBody.insertRow();
                    const headerCell = headerRow.insertCell(0);
                    const authorLink = document.createElement('a');
                    authorLink.href = author.ProfileLink;
                    authorLink.textContent = `${authorCounter}. ${author.Name || 'N/A'}`;
                    authorLink.target = '_blank';  // open in new tab
                    headerCell.appendChild(authorLink);
                    headerCell.style.fontWeight = 'bold';
                    headerCell.colSpan = 4;
                    headerCell.style.backgroundColor = '#f0f0f0';

            // Add each paper as a row
            author.ScopusPapers.forEach(paper => {
                const row = paperDetailsScopusTableBody.insertRow();
                row.insertCell(0).innerText = `${authorCounter}.${paperCounter}`;
                row.insertCell(1).innerText = paper.title || 'N/A';
                row.insertCell(2).innerText = paper.year || 'N/A';
                row.insertCell(3).innerText = paper.citations || 'N/A';

                paperCounter++;
            });

            // Add a spacer row
            const spacerRow = paperDetailsScopusTableBody.insertRow();
            spacerRow.insertCell(0).colSpan = 4;
            spacerRow.style.height = '10px';

            authorCounter++;
        });
        paperDetailsScopusContainer.classList.remove('hidden');
        showDownloadButton();
    

            }  else if (source === 'paperDetails') {
    let authorCounter = 1;

    data.forEach(author => {
        let paperCounter = 1;
        
        // Add author name as a header row
        const headerRow = paperDetailsTableBody.insertRow();
        const headerCell = headerRow.insertCell(0);
        headerCell.innerText = `${authorCounter}. ${author.Name || 'N/A'}`;
        headerCell.style.fontWeight = 'bold';
        headerCell.colSpan = 5; 
        headerCell.style.backgroundColor = '#f0f0f0';

        // Add each paper as a row
        author.Papers.forEach(paper => {
            const row = paperDetailsTableBody.insertRow();
            row.insertCell(0).innerText = `${authorCounter}.${paperCounter}`;
            row.insertCell(1).innerText = paper.title || 'N/A';
            row.insertCell(2).innerText = paper.year || 'N/A';
            row.insertCell(3).innerText = paper.citations || 'N/A';
            
            // Add a link cell if you have links to the papers
            const linkCell = row.insertCell(4);
            if (paper.link) {
                const link = document.createElement('a');
                link.href = paper.link;
                link.textContent = 'View';
                link.target = '_blank';
                linkCell.appendChild(link);
            } else {
                linkCell.innerText = 'N/A';
            }

            paperCounter++;
        });

        const spacerRow = paperDetailsTableBody.insertRow();
        spacerRow.insertCell(0).colSpan = 5;
        spacerRow.style.height = '10px';

        authorCounter++;
    });
    paperDetailsContainer.classList.remove('hidden');
    showDownloadButton();
 } else {
                data.forEach(author => {
                    const row = resultsTableBody.insertRow();
                    row.insertCell(0).innerText = author.Name || 'N/A';
                    row.insertCell(1).innerText = author['Total Papers (Google Scholar)'] || 'N/A';
                    row.insertCell(2).innerText = author['Total Citations (Google Scholar)'] || 'N/A';
                    row.insertCell(3).innerText = author['H-Index (Google Scholar)'] || 'N/A';
                    row.insertCell(4).innerText = author['I10 Index (Google Scholar)'] || 'N/A';
                    row.insertCell(5).innerText = author['Total Papers (Scopus)'] || 'N/A';
                    row.insertCell(6).innerText = author['Total Citations (Scopus)'] || 'N/A';
                    row.insertCell(7).innerText = author['H-Index (Scopus)'] || 'N/A';
                });

                resultContainer.classList.remove('hidden');
                showDownloadButton();
            } 
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
    });

function showDownloadButton() {
    const resultContainer = document.getElementById('resultContainer');
    const googleScholarOnlyContainer = document.getElementById('googleScholarOnlyContainer');
    const paperDetailsContainer = document.getElementById('paperDetailsContainer');
    const paperDetailsScopusContainer = document.getElementById('paperDetailsScopusContainer');
    const downloadBtn = document.getElementById('download-btn');

    const hasData = 
        (!resultContainer.classList.contains('hidden') && document.getElementById('resultsTable').rows.length > 1) ||
        (!googleScholarOnlyContainer.classList.contains('hidden') && document.getElementById('googleScholarOnlyTable').rows.length > 1) ||
        (!paperDetailsContainer.classList.contains('hidden') && document.getElementById('paperDetailsTable').rows.length > 1) ||
        (!paperDetailsScopusContainer.classList.contains('hidden') && document.getElementById('paperDetailsScopusTable').rows.length > 1);

    downloadBtn.style.display = hasData ? 'block' : 'none';
}
function downloadExcel() {
    let tableId;
    let fileName;

    if (!document.getElementById('resultContainer').classList.contains('hidden') && document.getElementById('resultsTable').rows.length > 1) {
        tableId = 'resultsTable';
        if (document.querySelector('input[name="citationSource"]:checked').value === 'average') {
            fileName = 'Average_Citations_Data.xlsx';
        } else {
            fileName = 'Google_Scholar_and_Scopus_Data.xlsx';
        }
    } else if (!document.getElementById('googleScholarOnlyContainer').classList.contains('hidden') && document.getElementById('googleScholarOnlyTable').rows.length > 1) {
        tableId = 'googleScholarOnlyTable';
        fileName = 'Google_Scholar_Yearly_Citations.xlsx';
    } else if (!document.getElementById('paperDetailsContainer').classList.contains('hidden') && document.getElementById('paperDetailsTable').rows.length > 1) {
        tableId = 'paperDetailsTable';
        fileName = 'Google_Scholar_Paper_Details.xlsx';
    } else if (!document.getElementById('paperDetailsScopusContainer').classList.contains('hidden') && document.getElementById('paperDetailsScopusTable').rows.length > 1) {
        tableId = 'paperDetailsScopusTable';
        fileName = 'Scopus_Paper_Details.xlsx';
    }

    if (tableId) {
        const table = document.getElementById(tableId);
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, fileName);
    }
}
    
    </script>
</body>
</html>
